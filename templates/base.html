{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{% block title %}Fitlytics{% endblock %}</title>
  <link rel="icon" href="{% static 'img/favicon.ico' %}">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body class="site">
  <header class="nav">
    <a href="/">Fitlytics</a>
    <nav>
  <a href="{% url 'core:home' %}">Home</a>
  <a href="{% url 'nutrition:home' %}">Nutrition</a>
    <a href="{% url 'training:home' %}">Training</a>
      <a href="{% url 'metrics:home' %}">Metrics</a>
      {% if user.is_authenticated %}
        <span class="muted">Hello, {{ user.username }}</span>
        <a href="{% url 'accounts:logout' %}" class="btn ghost">Logout</a>
      {% else %}
        <a href="{% url 'accounts:login' %}" class="btn">Login</a>
        <a href="{% url 'accounts:signup' %}" class="btn primary">Sign Up</a>
      {% endif %}
    </nav>
  </header>
  <main class="container">
    {% block content %}{% endblock %}
  </main>
  <footer class="footer">© {{ now|default:"" }} Fitlytics</footer>
  <!-- AI Coach toggle -->
  <div id="ai-chat-toggle">AI Coach</div>

  <!-- AI Coach panel -->
  <div id="ai-chat-panel" class="card" style="position:fixed;bottom:1rem;right:1rem;width:320px;max-height:60vh;display:none;flex-direction:column;z-index:999;background:#fff;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.15);">
    <header style="display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;border-bottom:1px solid #eee;">
      <strong>AI Fitness Coach</strong>
      <button type="button" id="ai-chat-close" style="background:none;border:none;font-size:16px;cursor:pointer;">✕</button>
    </header>
    <div id="ai-chat-log" style="overflow-y:auto;font-size:.9rem;padding:.5rem .75rem;flex:1;"></div>
    <form id="ai-chat-form" style="display:flex;gap:.5rem;padding:.5rem .75rem;border-top:1px solid #eee;">
      <input name="q" id="ai-chat-input" class="input" placeholder="Ask a fitness or nutrition question..." style="flex:1;padding:.5rem;border:1px solid #ddd;border-radius:6px;">
      <button class="btn primary" type="submit" style="padding:.5rem .75rem;border:0;border-radius:6px;">Send</button>
    </form>
    <small class="muted" style="padding:0 .75rem .75rem;color:#6b7280;">Educational only. Not medical advice.</small>
  </div>

  <style>
    #ai-chat-toggle{
      position:fixed;bottom:1rem;right:1rem;background:var(--primary,#4f46e5);color:#fff;
      padding:.6rem .9rem;border-radius:999px;font-size:.85rem;cursor:pointer;z-index:998;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
    }
    #ai-chat-log .msg{margin-bottom:.6rem;white-space:pre-wrap;}
    #ai-chat-log .user{color:var(--primary,#4f46e5);}
    #ai-chat-log .ai{color:var(--accent,#14b8a6);}
  </style>

  <script>
    (function(){
      const toggle=document.getElementById('ai-chat-toggle');
      const panel=document.getElementById('ai-chat-panel');
      const closeBtn=document.getElementById('ai-chat-close');
      const form=document.getElementById('ai-chat-form');
      const log=document.getElementById('ai-chat-log');
      const input=document.getElementById('ai-chat-input');

      toggle.onclick=()=>panel.style.display='flex';
      closeBtn.onclick=()=>panel.style.display='none';

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const q=input.value.trim();
        if(!q) return;
        append('user', q);
        input.value='';
        append('ai', 'Thinking...');
        try{
          const fd=new FormData();
          fd.append('q', q);
          const res=await fetch('/ai/chat/', { method:'POST', body:fd, credentials:'same-origin' });
          const data=await res.json();
          log.lastElementChild.remove();
          append('ai', data.answer || 'No answer.');
        }catch(err){
          log.lastElementChild.remove();
          append('ai', 'Error contacting AI.');
        }
      });

      function append(role, text){
        const div=document.createElement('div');
        div.className='msg '+role;
        div.textContent = role==='ai' ? text : 'You: '+text;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
      }
    })();
  </script>
</body>
</html>